<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>WeiFeng AI - Bluetooth Handshake Tester</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00e5ff; font-family: 'Courier New', monospace; overflow: hidden; }
        #console { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(10, 10, 10, 0.9); padding: 20px; border: 1px solid #00e5ff; border-radius: 10px; width: 320px; box-shadow: 0 0 15px #00e5ff44; }
        .log { height: 150px; background: #000; border: 1px solid #333; margin-top: 10px; padding: 5px; font-size: 11px; overflow-y: auto; color: #0f0; }
        button { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #00e5ff; color: #000; }
        #syncBtn { background: #222; color: #00e5ff; border: 1px solid #00e5ff; }
    </style>
</head>
<body>

<div id="console">
    <h2 style="margin:0; font-size:1.1rem;">WeiFeng è—ç‰™å”è­°æ¸¬è©¦</h2>
    <div class="log" id="statusLog">> ç³»çµ±å°±ç·’ï¼Œç­‰å¾… Chrome æˆæ¬Š...</div>
    <button id="connectBtn">âš¡ åŸ·è¡Œ csTimer å”è­°é€£çµ</button>
    <button id="syncBtn">ğŸ”„ æ¨¡å‹åŒæ­¥å›æ­£</button>
    <p style="font-size:10px; color:#555; margin-top:10px;">åƒè€ƒä¾†æº: csTimer/src/js/bluetooth/gan.js</p>
</div>

<div id="canvas-container"></div>

<script>
    let cube;
    const logBox = document.getElementById('statusLog');
    const GAN_SERVICE = '00001a00-0000-1000-8000-00805f9b34fb';
    const GAN_CHAR = '00001a01-0000-1000-8000-00805f9b34fb';

    function addLog(msg) {
        logBox.innerHTML += `<div>> ${msg}</div>`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    // --- 3D è¦–è¦ºé¡¯ç¤º ---
    function init3D() {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const group = new THREE.Group();
        const colors = [0xffffff, 0xffff00, 0xff0000, 0xffa500, 0x00ff00, 0x0000ff];
        for (let x = -1; x <= 1; x++) {
            for (let y = -1; y <= 1; y++) {
                for (let z = -1; z <= 1; z++) {
                    const m = new THREE.Mesh(new THREE.BoxGeometry(0.9, 0.9, 0.9), colors.map(c => new THREE.MeshLambertMaterial({color:c})));
                    m.position.set(x, y, z);
                    group.add(m);
                }
            }
        }
        cube = group; scene.add(cube);
        scene.add(new THREE.AmbientLight(0xffffff, 1));
        camera.position.set(3, 3, 5); camera.lookAt(0,0,0);
        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
        animate();
    }

    // --- æ ¸å¿ƒè—ç‰™æ¸¬è©¦ (æ¨¡ä»¿ csTimer é‚è¼¯) ---
    document.getElementById('connectBtn').onclick = async () => {
        try {
            addLog("æœå°‹ GAN é­”æ–¹ä¸­...");
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'GAN' }],
                optionalServices: [GAN_SERVICE]
            });

            addLog("æ­£åœ¨é€£ç·š GATT Server...");
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(GAN_SERVICE);
            const characteristic = await service.getCharacteristic(GAN_CHAR);

            // csTimer é—œéµæ­¥é©Ÿï¼šè¨‚é–±é€šçŸ¥
            await characteristic.startNotifications();
            addLog("âœ… é€šé“é–‹å•ŸæˆåŠŸï¼");

            // æ¨¡æ“¬ csTimer çš„æ¡æ‰‹ (éƒ¨åˆ†å‹è™Ÿéœ€è¦å‚³å…¥æŒ‡ä»¤æ‰æœƒé–‹å§‹å»£æ’­æ•¸æ“š)
            addLog("æ­£åœ¨åŸ·è¡Œå”è­°æ¡æ‰‹...");
            
            characteristic.addEventListener('characteristicvaluechanged', (event) => {
                const data = event.target.value;
                addLog(`æ¥æ”¶æ•¸æ“š: ${data.byteLength} å­—ç¯€ (Hex: ${data.getUint8(0).toString(16)})`);
                
                // æ”¶åˆ°ä»»ä½•æ•¸æ“šå³ä»£è¡¨é€šè¨ŠæˆåŠŸï¼Œè®“æ¨¡å‹è½‰å‹•ä½œç‚ºåé¥‹
                cube.rotation.y += 0.5;
            });

        } catch (err) {
            addLog(`âŒ å¤±æ•—: ${err.message}`);
        }
    };

    document.getElementById('syncBtn').onclick = () => {
        cube.rotation.set(0, 0, 0);
        addLog("3D ç‹€æ…‹å·²é‡ç½®ã€‚");
    };

    init3D();
</script>
</body>
</html>