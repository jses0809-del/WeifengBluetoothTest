<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>WeiFeng AI - Ultimate Link</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00e5ff; font-family: monospace; overflow: hidden; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(10,10,10,0.9); padding: 20px; border: 1px solid #00e5ff; border-radius: 10px; width: 320px; }
        .log { height: 180px; background: #000; border: 1px solid #333; margin-top: 10px; padding: 8px; font-size: 11px; overflow-y: auto; color: #0f0; line-height: 1.4; }
        button { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #00e5ff; color: #000; font-size: 1rem; }
        #syncBtn { background: #222; color: #00e5ff; border: 1px solid #00e5ff; }
    </style>
</head>
<body>

<div id="ui">
    <h2 style="margin:0;">WeiFeng AI ç©¶æ¥µé€£ç·š</h2>
    <div class="log" id="statusLog">> ç­‰å¾…æŒ‡ä»¤...</div>
    <button id="connectBtn">âš¡ å…¨è‡ªå‹•æƒæé€£ç·š</button>
    <button id="syncBtn">ğŸ”„ 3D æ¨¡å‹å¾©ä½</button>
</div>

<script>
    let cube;
    const logBox = document.getElementById('statusLog');
    function addLog(msg) { logBox.innerHTML += `<div>> ${msg}</div>`; logBox.scrollTop = logBox.scrollHeight; }

    // --- 3D è¦–è¦º ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    const group = new THREE.Group();
    const colors = [0xffffff, 0xffff00, 0xff0000, 0xffa500, 0x00ff00, 0x0000ff];
    for(let x=-1;x<=1;x++) for(let y=-1;y<=1;y++) for(let z=-1;z<=1;z++){
        const m = new THREE.Mesh(new THREE.BoxGeometry(0.9,0.9,0.9), colors.map(c=>new THREE.MeshLambertMaterial({color:c})));
        m.position.set(x,y,z); group.add(m);
    }
    cube = group; scene.add(cube);
    scene.add(new THREE.AmbientLight(0xffffff, 1));
    camera.position.set(3,3,5); camera.lookAt(0,0,0);
    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
    animate();

    // --- ç©¶æ¥µé€£ç·šé‚è¼¯ ---
    document.getElementById('connectBtn').onclick = async () => {
        try {
            addLog("æ­£åœ¨å»£åŸŸæœå°‹è—ç‰™è¨­å‚™...");
            // ä¸æŒ‡å®š UUIDï¼Œç›´æ¥åˆ—å‡ºæ‰€æœ‰è¨­å‚™ï¼Œé¿é–‹ UUID ä¸åŒ¹é…å•é¡Œ
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [
                    '00001a00-0000-1000-8000-00805f9b34fb',
                    '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
                    '0000ffe0-0000-1000-8000-00805f9b34fb'
                ]
            });

            addLog(`å·²é€£çµ: ${device.name}ï¼Œæ­£åœ¨è®€å–é€šè¨Šå”å®š...`);
            const server = await device.gatt.connect();
            
            // å…¨è‡ªå‹•éæ­·æ‰€æœ‰ Service
            const services = await server.getPrimaryServices();
            addLog(`æ‰¾åˆ° ${services.length} å€‹æœå‹™ï¼Œæ­£åœ¨å°‹æ‰¾æ•¸æ“šé€šé“...`);

            for (const service of services) {
                const chars = await service.getCharacteristics();
                for (const char of chars) {
                    // åªè¦é€™å€‹é€šé“æ”¯æ´ã€Œé€šçŸ¥ (Notify)ã€ï¼Œå®ƒå°±æ˜¯æˆ‘å€‘è¦çš„é­”æ–¹æ•¸æ“šå£
                    if (char.properties.notify) {
                        await char.startNotifications();
                        char.addEventListener('characteristicvaluechanged', (e) => {
                            const raw = new Uint8Array(e.target.value.buffer);
                            addLog(`æ”¶åˆ°æ•¸æ“š: ${raw[0].toString(16)}...`);
                            cube.rotation.y += 0.5; // è½‰å‹•é­”æ–¹ä½œç‚ºåé¥‹
                        });
                        addLog("âœ… æˆåŠŸï¼æ•¸æ“šé€šé“å·²é–å®šã€‚");
                        return;
                    }
                }
            }
            addLog("âŒ æ‰¾ä¸åˆ°å¯ç”¨çš„æ•¸æ“šé€šçŸ¥é€šé“ã€‚");
        } catch (err) {
            addLog(`âŒ å¤±æ•—: ${err.message}`);
        }
    };

    document.getElementById('syncBtn').onclick = () => { cube.rotation.set(0,0,0); addLog("æ¨¡å‹å·²å›æ­£ã€‚"); };
</script>
</body>
</html>