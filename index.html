<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>WeiFeng AI - Bluetooth Link</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00e5ff; font-family: 'Courier New', monospace; overflow: hidden; }
        #panel { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(15, 15, 15, 0.95); padding: 25px; border-radius: 20px; border: 2px solid #00e5ff; width: 280px; box-shadow: 0 0 20px #00e5ff33; }
        h1 { margin: 0 0 15px 0; font-size: 1.4rem; text-align: center; letter-spacing: 2px; }
        .status-box { border: 1px solid #333; padding: 10px; font-size: 0.8rem; margin-bottom: 20px; color: #888; background: #000; min-height: 40px; }
        button { width: 100%; padding: 15px; margin-bottom: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        #connectBtn { background: linear-gradient(45deg, #007bff, #00e5ff); color: white; }
        #syncBtn { background: #333; color: #00e5ff; border: 1px solid #00e5ff; }
        button:hover { transform: scale(1.03); filter: brightness(1.2); }
        #canvas-container { width: 100vw; height: 100vh; }
    </style>
</head>
<body>

<div id="panel">
    <h1>WeiFeng AI</h1>
    <div id="status" class="status-box">æº–å‚™å°±ç·’ï¼šç­‰å¾…é€£ç·š...</div>
    <button id="connectBtn">âš¡ é€£çµ GAN é­”æ–¹</button>
    <button id="syncBtn">ğŸ”„ åŒæ­¥ (æ¨¡å‹å›æ­£)</button>
    <div style="font-size: 0.7rem; color: #555;">æ³¨æ„ï¼šè«‹ç¢ºä¿ä½¿ç”¨æ”¯æ´è—ç‰™çš„ç’°å¢ƒé–‹å•Ÿæ­¤ HTML</div>
</div>

<div id="canvas-container"></div>

<script>
    let scene, camera, renderer, cubeGroup;
    const SERVICE_UUID = '00001a00-0000-1000-8000-00805f9b34fb';
    const CHARACTER_UUID = '00001a01-0000-1000-8000-00805f9b34fb';

    // --- 3D æ¸²æŸ“ç³»çµ± (ä¸€æ•´é¡†é­”æ–¹ï¼Œä¸å†æ˜¯æ­£æ–¹å½¢) ---
    function init3D() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        cubeGroup = new THREE.Group();
        // å»ºç«‹ 27 å€‹å°æ–¹å¡Š
        const colors = [0xffffff, 0xffff00, 0xff0000, 0xffa500, 0x00ff00, 0x0000ff];
        for (let x = -1; x <= 1; x++) {
            for (let y = -1; y <= 1; y++) {
                for (let z = -1; z <= 1; z++) {
                    const geometry = new THREE.BoxGeometry(0.9, 0.9, 0.9);
                    const materials = colors.map(c => new THREE.MeshLambertMaterial({ color: c }));
                    const piece = new THREE.Mesh(geometry, materials);
                    piece.position.set(x, y, z);
                    cubeGroup.add(piece);
                }
            }
        }
        scene.add(cubeGroup);
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const light = new THREE.PointLight(0xffffff, 1);
        light.position.set(10, 10, 10);
        scene.add(light);

        camera.position.set(4, 4, 5);
        camera.lookAt(0, 0, 0);
        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    // --- è—ç‰™æ ¸å¿ƒåŠŸèƒ½ ---
    const statusDiv = document.getElementById('status');

    document.getElementById('connectBtn').onclick = async () => {
        if (!navigator.bluetooth) {
            statusDiv.style.color = "#ff4444";
            statusDiv.innerText = "âŒ å¤±æ•—ï¼šSafari/Google ä¸æ”¯æ´è—ç‰™ã€‚";
            alert("ç›®å‰ç’°å¢ƒç„¡æ³•é€£ç·šè—ç‰™ã€‚è«‹ä¸Šå‚³è‡³ GitHub ä¸¦ç”¨ Bluefy æˆ–é›»è…¦ Chrome é–‹å•Ÿã€‚");
            return;
        }

        try {
            statusDiv.innerText = "ğŸ” æœå°‹ GAN é­”æ–¹ä¸­...";
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'GAN' }],
                optionalServices: [SERVICE_UUID]
            });

            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            const characteristic = await service.getCharacteristic(CHARACTER_UUID);

            await characteristic.startNotifications();
            statusDiv.style.color = "#00ff88";
            statusDiv.innerText = "âœ… å·²æˆåŠŸé€£ç·šè‡³ " + device.name;

            characteristic.addEventListener('characteristicvaluechanged', (e) => {
                // ç•¶ä½ è½‰å‹•é­”æ–¹ï¼Œé€™æ®µä»£ç¢¼æœƒè¢«è§¸ç™¼
                // æˆ‘å€‘è®“ 3D é­”æ–¹éš¨æ©Ÿè½‰ä¸€ä¸‹ï¼Œè­‰æ˜é€£ç·šæˆåŠŸ
                cubeGroup.rotation.y += Math.PI / 2;
                statusDiv.innerText = "æ¥æ”¶è½‰å‹•æ•¸æ“šä¸­...";
            });

        } catch (err) {
            statusDiv.innerText = "é€£ç·šå¤±æ•—ï¼š" + err.message;
        }
    };

    // --- åŒæ­¥éµï¼šå¼·åˆ¶æ­¸é›¶ ---
    document.getElementById('syncBtn').onclick = () => {
        cubeGroup.rotation.set(0, 0, 0);
        statusDiv.innerText = "ç‹€æ…‹åŒæ­¥ï¼šå·²æ­¸ä½ç‚ºå¾©åŸç‹€æ…‹";
    };

    window.onresize = () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    };

    init3D();
</script>
</body>
</html>