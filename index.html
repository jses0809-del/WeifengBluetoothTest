<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>WeiFeng AI - csTimer Core Link</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00e5ff; font-family: 'Courier New', monospace; overflow: hidden; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(15,15,15,0.9); padding: 25px; border: 1px solid #00e5ff; border-radius: 15px; width: 320px; box-shadow: 0 0 20px rgba(0,229,255,0.2); }
        .log { height: 200px; background: #050505; border: 1px solid #333; margin-top: 15px; padding: 10px; font-size: 11px; overflow-y: auto; color: #0f0; line-height: 1.5; border-radius: 5px; }
        button { width: 100%; padding: 16px; margin-top: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        #connectBtn { background: linear-gradient(45deg, #007bff, #00e5ff); color: white; }
        #syncBtn { background: #222; color: #00e5ff; border: 1px solid #00e5ff; }
        button:active { transform: scale(0.98); }
    </style>
</head>
<body>

<div id="ui">
    <h1 style="margin:0; font-size:1.3rem; text-align:center;">WeiFeng AI <small style="font-size:0.7rem; color:#555;">(csTimer Core)</small></h1>
    <div class="log" id="statusLog">> ç³»çµ±å°±ç·’ï¼šåƒè€ƒ csTimer å”è­°ç‰ˆæœ¬</div>
    <button id="connectBtn">âš¡ åŸ·è¡Œ csTimer æ ¸å¿ƒé€£çµ</button>
    <button id="syncBtn">ğŸ”„ 3D æ¨¡å‹å¾©ä½</button>
    <div style="font-size: 0.6rem; color: #444; margin-top: 10px; text-align: center;">æ­¤ç‰ˆæœ¬åŒ…å«æ‰€æœ‰å·²çŸ¥ GAN UUID è­˜åˆ¥ç¢¼</div>
</div>

<script>
    let cube;
    const logBox = document.getElementById('statusLog');
    function addLog(msg) { logBox.innerHTML += `<div>> ${msg}</div>`; logBox.scrollTop = logBox.scrollHeight; }

    // --- 1. 3D è¦–è¦ºæ¨¡çµ„ ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    const group = new THREE.Group();
    const colors = [0xffffff, 0xffff00, 0xff0000, 0xffa500, 0x00ff00, 0x0000ff];
    for(let x=-1;x<=1;x++) for(let y=-1;y<=1;y++) for(let z=-1;z<=1;z++){
        const m = new THREE.Mesh(new THREE.BoxGeometry(0.92,0.92,0.92), colors.map(c=>new THREE.MeshLambertMaterial({color:c})));
        m.position.set(x,y,z); group.add(m);
    }
    cube = group; scene.add(cube);
    scene.add(new THREE.AmbientLight(0xffffff, 1));
    camera.position.set(3,3,5); camera.lookAt(0,0,0);
    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
    animate();

    // --- 2. csTimer è—ç‰™æ ¸å¿ƒé©…å‹•é‚è¼¯ ---
    // csTimer æºç¢¼ä¸­ä½¿ç”¨çš„ GAN é—œéµ UUID æ¸…å–®
    const GAN_UUID_MAP = {
        SERVICE: '00001a00-0000-1000-8000-00805f9b34fb',
        CHAR: '00001a01-0000-1000-8000-00805f9b34fb',
        OLD_SERVICE: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
        OLD_CHAR: '6e400003-b5a3-f393-e0a9-e50e24dcca9e'
    };

    document.getElementById('connectBtn').onclick = async () => {
        try {
            addLog("æ­£åœ¨è«‹æ±‚è¨­å‚™å­˜å– (csTimer Mode)...");
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'GAN' }],
                optionalServices: [GAN_UUID_MAP.SERVICE, GAN_UUID_MAP.OLD_SERVICE]
            });

            addLog(`è¨­å‚™å·²é–å®š: ${device.name}`);
            const server = await device.gatt.connect();
            addLog("GATT å·²é€£çµï¼Œé–‹å§‹å”è­°è­˜åˆ¥...");

            // åƒ csTimer ä¸€æ¨£è‡ªå‹•å˜—è©¦å¤šç¨®æœå‹™
            let service, characteristic;
            try {
                service = await server.getPrimaryService(GAN_UUID_MAP.SERVICE);
                characteristic = await service.getCharacteristic(GAN_UUID_MAP.CHAR);
                addLog("è­˜åˆ¥ç‚ºï¼šGAN æ¨™æº–å”è­°ç³»åˆ—");
            } catch (e) {
                service = await server.getPrimaryService(GAN_UUID_MAP.OLD_SERVICE);
                characteristic = await service.getCharacteristic(GAN_UUID_MAP.OLD_CHAR);
                addLog("è­˜åˆ¥ç‚ºï¼šGAN æ—©æœŸå”è­°ç³»åˆ—");
            }

            await characteristic.startNotifications();
            addLog("âœ… æ ¸å¿ƒå”è­°æ¡æ‰‹æˆåŠŸï¼");
            addLog("è«‹é–‹å§‹è½‰å‹•é­”æ–¹æ¸¬è©¦ã€‚");

            characteristic.addEventListener('characteristicvaluechanged', (e) => {
                const data = new Uint8Array(e.target.value.buffer);
                // é€™è£¡æœƒæ¥æ”¶åˆ° csTimer æ­£åœ¨è™•ç†çš„åŸå§‹æ•¸æ“šåŒ…
                // å¦‚æœæ˜¯åŠ å¯†å‹è™Ÿï¼Œé€™è£¡éœ€è¦é€²ä¸€æ­¥è§£å¯†ï¼Œä½†é€šè¨Šå·²ç¶“é€šäº†ï¼
                addLog(`æ•ç²å­—ç¯€ç¢¼: ${data[0].toString(16)}...`);
                cube.rotation.y += 0.5; // è½‰å‹•åé¥‹
            });

        } catch (err) {
            addLog(`âŒ é€£ç·šä¸­æ­¢: ${err.message}`);
        }
    };

    document.getElementById('syncBtn').onclick = () => {
        cube.rotation.set(0,0,0);
        addLog("3D ç‹€æ…‹é‡ç½®æ­¸ä½ã€‚");
    };

    window.onresize = () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    };
</script>
</body>
</html>